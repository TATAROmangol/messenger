# Instant messenger

## DevOps: Инфраструктура и мониторинг
### Docker Compose Services
Конфигурация разворачивает следующие сервисы:

| Сервис     | Порт | Доступ в браузере                | Описание                     |
|------------|------|----------------------------------|------------------------------|
| PostgreSQL | 5432 | -                                | Основная база данных         |
| pgAdmin    | 5050 | [Перейти](http://localhost:5050) | Веб-интерфейс для PostgreSQL |
| Kafka      | 9092 | -                                | Брокер сообщений             |
| Kafka UI   | 8085 | [Перейти](http://localhost:8085) | Управление топиками Kafka    |
| Promtail   | 9080 | -                                | Агент для сбора логов        |
| Loki       | 3100 | [Перейти](http://localhost:3100) | Хранилище логов              |
| Prometheus | 9090 | [Перейти](http://localhost:9090) | Мониторинг метрик            |
| Grafana    | 3000 | [Перейти](http://localhost:3000) | Визуализация данных          |

### Как проверить работу сервисов
#### Kafka UI:
- Откройте [Kafka UI](http://localhost:8080)
- Проверьте список топиков (должен быть пустым при первом запуске)
- Для теста создайте топик: `test-topic` с 3 партициями
#### Grafana:
- Логин: `admin` / пароль: `admin`
- Добавьте источники данных:
  - Prometheus: `http://prometheus:9090`
  - Loki: `http://loki:3100`
- Импортируйте дашборды для Kafka и Docker
**ℹ️ Info**
> Файл с источником данных уже добавлен в deployments/grafana/datasource.yaml  
> Пример дашборда для Kafka уже добавлен в deployments/grafana/example-dashboard.json
#### pgAdmin:
- Логин: `admin` / пароль: `admin`
- Добавьте сервер PostgreSQL:
  - Host: `postgres`
  - Пользователь: `postgres`
  - Пароль: `postgres`
  - База данных: `yandex`
#### Kafka:
- Автосоздание топиков включено (`KAFKA_AUTO_CREATE_TOPICS_ENABLE=true`)
> **⚠️ Warning**
> При подключении к топику он будет создаваться автоматически
- Для подключения из контейнеров используйте адрес `kafka:29092`
- Для локального тестирования - `localhost:9092`
#### Мониторинг:
- Prometheus настроен на сбор метрик:
  - Kafka (через JMX)
  - Docker (через cAdvisor) 
> при объединении всех контейнеров настроим на сбор метрик из нескольких сервисов 
- Loki получает логи через Promtail
#### Логирование:
- Все логи контейнеров автоматически отправляются в Loki 
> при объединении всех контейнеров настроим на сбор метрик из нескольких сервисов
- Пример запроса в Grafana: `{container_name="kafka"} |= "error"`

## AUTH-SERVICE

Архитектура сервиса

```
.
├── api
│   └── auth.proto ................ proto-файл сервиса
├── cmd
│   └── auth.go ................... точка входа, запускающая сервис полностью
├── config
│   └── example.env ............... пример значений конфигурационного файла
├── db/migrations/ ................ миграция
├── docker-compose.yml ............ описание контейнера postgres (TODO: запуск auth_service)
├── internal
│   ├── config
│   │   └── config.go ............. программа, читающая конфиг
│   └── transport
│       ├── entity.go ............. описание запросов и ответов, обрабатываемых сервисом, глобальных переменных
│       ├── grpc.go ............... реализация Validate(...), GetUser(...)
│       └── rest.go ............... реализация Register(...), Login(...), Logout(...), Delete(...)
├── Makefile ...................... команды сборки и запуска
└── pkg
    ├── api/ ...................... GRPC-код, сгенерировано protoc
    ├── logger
    │   └── logger.go ............. логгер
    └── postgres
        └── postgres.go ........... основная логика работы (CRUD) с пользователями. Работа с базой данных
```

### 1. Зарегистрировать пользователя

**POST** `/auth/register`

**Описание:** записывает куки "user_jwt" с токеном регистрации. Возвращает ошибку через http.Error(w, ...) если таковая возникла.

**Тело запроса**

```json
{
    "login":"andrey_3000",
    "email":"andreymail@mail.com",
    "pass":"superstrong",
    "name":"Andrew"
}
```

**Ответ:**

```json
{
    "token": "eyJ.eyX.QWd"
}
```

**Коды ответа:**

- `201 Created` — Успешно
- `400 Bad Request` — Неверный формат запроса
- `500 Internal Server Error` — Ошибка сервера - JWT или Postgres

---

### 2. Залогиниться в систему

**POST** `/auth/login`

**Описание:** записывает куки "user_jwt" с токеном регистрации. Возвращает ошибку через http.Error(w, ...) если таковая возникла.

**Тело запроса**

```json
{
    "credential":"andrey_3000",
    "pass":"superstrong"
}
```

***!!! credential - ИЛИ login, ИЛИ email***

**Ответ:**

```json
{
    "token": "eyJ.eyX.QWd"
}
```

**Коды ответа:**

- `201 Created` — Успешно
- `400 Bad Request` — Неверный формат запроса
- `500 Internal Server Error` — Ошибка сервера - JWT или Postgres

---

### 3. Разлогиниться из системы

**POST** `/auth/logout`

**Описание:** удаляет куки "user_jwt" из запроса

**Тело запроса - пустое**

**Ответ - пустой**

**Коды ответа:**

- `200 OK` — Успешно
- `400 Bad Request` — Нет куки "user_jwt" - неоткуда разлогиниваться!
- `500 Internal Server Error` — Ошибка сервера - не распознается содержимое куки

---

### 4. Удалить пользователя

**POST** `/auth/delete`

**Описание:** удаляет запись о пользователе из базы данных сервиса Auth, затем удаляет куки "user_jwt" из запроса

**Тело запроса - пустое**

**Ответ - пустой**

**Коды ответа:**

- `200 OK` — Успешно
- `400 Bad Request` — Нет куки "user_jwt" - неоткуда разлогиниваться!
- `500 Internal Server Error` — Ошибка сервера - JWT или Postgres

---

### 5. Проверить токен на валидность и достать id (GRPC)

**POST** `/Validate`

**Описание:** принимает токен регистрации, возвращает id пользователя, если успешно, -1, если ошибка.

**Тело запроса**
```json
{
    "token":"eyJ.eyX.QWd"
}
```

**Ответ**
```json
{
    "id":123
}
```

**Ответы:**

- `id > 0 && err = nil` — Успешно
- `id < 0` — Ошибка сервера - см. её в `err`

---

### 5. Взять запись из Postgres по id (GRPC)

**POST** `/GetUser`

**Описание:** принимает id пользователя, возвращает его login, email и name. Пустые строки, если ошибка.

**Тело запроса**
```json
{
    "id":123
}
```

**Ответ**
```json
{
    "login":"andrey_3000",
    "email":"andreymail@mail.com",
    "name":"Andrew"
}
```

**Ответы:**

- `login != "" && err = nil` — Успешно. Email и Name - необязательные поля, по ним не определить, возникла ли ошибка
- `login == ""` — Ошибка сервера - см. её в `err`

---

5. Validate (GRPC)

- принимает токен регистрации, возвращает id пользователя, если успешно, -1, если ошибка.

6. GetUser (GRPC)

- принимает id пользователя, возвращает его login, email и name. Пустые строки, если ошибка.

## Chat-service

### 1. Получить список чатов пользователя

**GET** `/chat`

**Описание:** Возвращает список идентификаторов чатов, в которых участвует авторизованный пользователь.

**Ответ:**

```json
{
"chats": [1, 2, 3]
}
```

**Коды ответа:**

- `200 OK` — Успешно
- `400 Bad Request` — Невалидный ID пользователя
- `500 Internal Server Error` — Ошибка сервера

---

### 2. Создать новый чат

**POST** `/chat/create`

**Описание:** Создает новый чат между текущим пользователем и другим пользователем.

**Тело запроса:**

```json
{
"user_id_2": 42
}
```

**Ответ:**

```json
{
"chat_id": 5
}
```

**Коды ответа:**

- `201 Created` — Чат создан
- `400 Bad Request` — Невалидный ID пользователя или тело запроса
- `500 Internal Server Error` — Ошибка сервера

---

### 3. Отправить сообщение в чат

**POST** `/chat/{chat_id}`

**Описание:** Отправляет сообщение в чат от имени текущего пользователя.

**Параметры пути:**

- `chat_id` — ID чата (целое число)

**Тело запроса:**

```json
{
"text": "Привет!"
}
```

**Ответ:**

```json
{
"message_id": 17
}
```

**Коды ответа:**

- `201 Created` — Сообщение отправлено
- `400 Bad Request` — Проблемы с ID или текстом
- `500 Internal Server Error` — Ошибка сервера

---

### 4. Получить сообщения из чата

**GET** `/chat/{chat_id}/messages?limit=20&offset=0`

**Описание:** Получает список сообщений из указанного чата с пагинацией.

**Параметры пути:**

- `chat_id` — ID чата (целое число)

**Query параметры:**

- `limit` — Максимум сообщений (опционально)
- `offset` — Смещение (опционально)

**Ответ:**

```json
[
{
"text": "Привет!",
"created_at": "2025-04-22T12:00:00Z",
"is_read": "true"
},
{
"text": "Здарова!",
"created_at": "2025-05-21T12:00:00Z",
"is_read": "true"
}
]
```

**Коды ответа:**

- `200 OK` — Успешно
- `400 Bad Request` — Невалидный ID чата
- `500 Internal Server Error` — Ошибка сервера
